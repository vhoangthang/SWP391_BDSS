@model BloodDonation.Models.BloodRequest

@{
    Layout = "~/Views/Shared/_LayoutStaff.cshtml";
    ViewData["Title"] = "Chi ti·∫øt y√™u c·∫ßu nh·∫≠n m√°u";
    var inventories = ViewBag.AllBloodInventories as List<BloodDonation.Models.BloodInventory>;
}

<style>
    .bdss-card {
        border-radius: 1.2rem;
        box-shadow: 0 2px 16px 0 rgba(0,0,0,0.07);
        border: none;
        background: #fff;
        padding: 2rem 2.5rem 2rem 2.5rem;
        margin-bottom: 1.5rem;
    }
    .bdss-title {
        font-size: 1.5em;
        font-weight: 700;
        color: #22223b;
        margin-bottom: 1.2em;
    }
    .bdss-label {
        color: #64748b;
        font-weight: 500;
        font-size: 1em;
        margin-bottom: 0.2em;
        min-width: 120px;
        display: block;
    }
    .bdss-value {
        font-weight: 600;
        color: #22223b;
        font-size: 1.08em;
        display: block;
        margin-bottom: 0.7em;
    }
    .bdss-badge-soft {
        display: inline-block;
        padding: 0.35em 1.1em;
        font-size: 1.1em;
        font-weight: 500;
        border-radius: 2em;
        background: #fef9c3;
        color: #b45309;
        letter-spacing: 0.02em;
        border: none;
    }
    .bdss-badge-soft-danger {
        background: #fde8e8;
        color: #b91c1c;
    }
    .bdss-badge-soft-warning {
        background: #fef9c3;
        color: #b45309;
    }
    .bdss-badge-soft-success {
        background: #d1fae5;
        color: #047857;
    }
    .bdss-btn-red {
        background: #ef4444;
        color: #fff;
        border-radius: 0.7em;
        font-weight: 600;
        border: none;
        padding: 0.7em 1.5em;
        margin-bottom: 0.5em;
        transition: background 0.2s;
        width: 100%;
    }
    .bdss-btn-red:hover {
        background: #b91c1c;
        color: #fff;
    }
    .bdss-btn-blue {
        background: #2563eb;
        color: #fff;
        border-radius: 0.7em;
        font-weight: 600;
        border: none;
        padding: 0.7em 1.5em;
        margin-bottom: 0.5em;
        transition: background 0.2s;
        width: 100%;
    }
    .bdss-btn-blue:hover {
        background: #1d4ed8;
        color: #fff;
    }
    .bdss-blood-inv-card {
        border-radius: 1em;
        background: #f8fafc;
        box-shadow: 0 1px 6px 0 rgba(0,0,0,0.04);
        padding: 1em 1.2em 0.7em 1.2em;
        margin-bottom: 0.7em;
        text-align: left;
    }
    .bdss-bloodtype-badge {
        display: inline-block;
        min-width: 2.2em;
        min-height: 2.2em;
        border-radius: 50%;
        background: #fee2e2;
        color: #ef4444;
        font-weight: 700;
        font-size: 1.1em;
        text-align: center;
        line-height: 2.2em;
        margin-right: 0.7em;
    }
    .bdss-qty-badge {
        background: #fef9c3;
        color: #78350f;
        border-radius: 1.2em;
        font-size: 1em;
        font-weight: 500;
        padding: 0.25em 1em;
        margin-left: 0.2em;
        margin-bottom: 0.2em;
        display: inline-block;
    }
</style>

<!-- Th√¥ng b√°o trung t√¢m -->
@if (TempData["Message"] != null)
{
    <div class="alert alert-success bdss-alert-center text-center" id="centerAlert" style="padding:2.2rem 1.5rem 1.2rem 1.5rem;">
        <div style="font-size:3rem;line-height:1;">
            <i class="fas fa-check-circle" style="color:#22c55e;"></i>
        </div>
        <div style="font-size:1.2rem;font-weight:600;">@TempData["Message"]</div>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger bdss-alert-center text-center" id="centerAlert" style="padding:2.2rem 1.5rem 1.2rem 1.5rem;">
        <div style="font-size:3rem;line-height:1;">
            <i class="fas fa-times-circle" style="color:#ef4444;"></i>
        </div>
        <div style="font-size:1.2rem;font-weight:600;">@TempData["Error"]</div>
    </div>
}
<script>
    setTimeout(function() {
        var alert = document.getElementById('centerAlert');
        if(alert) alert.style.display = 'none';
    }, 3500);
</script>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1 fw-bold">üìã Chi ti·∫øt y√™u c·∫ßu nh·∫≠n m√°u</h2>
                    <p class="text-muted mb-0">Th√¥ng tin chi ti·∫øt v·ªÅ y√™u c·∫ßu nh·∫≠n m√°u</p>
                </div>
                <a href="@Url.Action("BloodRequestList", "Staff")" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
                </a>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Card th√¥ng tin y√™u c·∫ßu (b·ªánh nh√¢n) -->
        <div class="col-lg-8">
            <div class="bdss-card">
                <div class="bdss-title">Th√¥ng tin y√™u c·∫ßu
                    @if (Model.IsEmergency)
                    {
                        <span class="bdss-badge-soft bdss-badge-soft-danger" style="font-size:1em;margin-left:1em;">Kh·∫©n c·∫•p</span>
                    }
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <span class="bdss-label">T√™n b·ªánh nh√¢n</span>
                        <span class="bdss-value">@Model.Reason</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">Tu·ªïi</span>
                        <span class="bdss-value">--</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">Gi·ªõi t√≠nh</span>
                        <span class="bdss-value">--</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">M√£ h·ªì s∆°</span>
                        <span class="bdss-value">--</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">Ch·∫©n ƒëo√°n</span>
                        <span class="bdss-value">--</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">Ti·ªÅn s·ª≠ truy·ªÅn m√°u</span>
                        <span class="bdss-value">Kh√¥ng</span>
                    </div>
                </div>
            </div>
            <div class="bdss-card">
                <div class="bdss-title" style="font-size:1.2em; margin-bottom:1em;">Chi ti·∫øt y√™u c·∫ßu m√°u</div>
                <div class="row">
                    <div class="col-md-6">
                        <span class="bdss-label">Nh√≥m m√°u y√™u c·∫ßu</span>
                        <span class="bdss-value">@Model.BloodType?.Type</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">Nh√≥m m√°u t∆∞∆°ng th√≠ch</span>
                        <span class="bdss-value">O+, O-</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">L∆∞·ª£ng m√°u c·∫ßn</span>
                        <span class="bdss-value">@Model.Quantity ml</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">Th√†nh ph·∫ßn m√°u</span>
                        <span class="bdss-value">@Model.BloodGiven</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">Th·ªùi gian c·∫ßn</span>
                        <span class="bdss-value">@Model.RequestDate.ToString("yyyy-MM-dd HH:mm")</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">Y√™u c·∫ßu ƒë·∫∑c bi·ªát</span>
                        <span class="bdss-value">Kh√¥ng</span>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="bdss-title" style="font-size:1.1em; margin-bottom:0.7em;">Kho m√°u hi·ªán t·∫°i</div>
                    <div class="row g-2">
                        @if (inventories != null)
                        {
                            foreach (var inv in inventories)
                            {
                                <div class="col-6 col-md-4 col-lg-3">
                                    <div class="bdss-blood-inv-card">
                                        <span class="bdss-bloodtype-badge">@inv.BloodType?.Type</span>
                                        <span class="bdss-qty-badge">@inv.Quantity ƒë∆°n v·ªã</span>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
            <div class="bdss-card">
                <div class="bdss-title" style="font-size:1.2em; margin-bottom:1em;">T√¨m ng∆∞·ªùi hi·∫øn m√°u g·∫ßn nh·∫•t</div>
                @if (ViewBag.NearbyDonors != null && ((IEnumerable<dynamic>)ViewBag.NearbyDonors).Any())
                {
                    <div class="table-responsive">
                        <table class="table table-borderless align-middle">
                            <thead>
                                <tr>
                                    <th>T√™n</th>
                                    <th>Nh√≥m m√°u</th>
                                    <th>S·ªë ƒëi·ªán tho·∫°i</th>
                                    <th>ƒê·ªãa ch·ªâ</th>
                                </tr>
                            </thead>
                            <tbody>
                            @foreach (var donor in ViewBag.NearbyDonors)
                            {
                                <tr>
                                    <td>@donor.Name</td>
                                    <td>@donor.Type</td>
                                    <td>@donor.ContactNumber</td>
                                    <td>@donor.Address</td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-muted">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi hi·∫øn m√°u ph√π h·ª£p g·∫ßn nh·∫•t.</div>
                }
            </div>
        </div>
        <!-- Card th√¥ng tin b·ªánh vi·ªán b√™n ph·∫£i -->
        <div class="col-lg-4">
            <div class="bdss-card">
                <div class="bdss-title" style="font-size:1.2em; margin-bottom:1.2em;">Th√¥ng tin b·ªánh vi·ªán</div>
                <span class="bdss-label">B·ªánh vi·ªán</span>
                <span class="bdss-value">@Model.MedicalCenter?.Name</span>
                <span class="bdss-label">ƒê·ªãa ch·ªâ</span>
                <span class="bdss-value">@Model.MedicalCenter?.Location</span>
                <span class="bdss-label">S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá</span>
                <span class="bdss-value">@Model.MedicalCenter?.ContactNumber</span>
                <span class="bdss-label">Khoa y√™u c·∫ßu</span>
                <span class="bdss-value">--</span>
                <span class="bdss-label">B√°c sƒ© ph·ª• tr√°ch</span>
                <span class="bdss-value">--</span>
            </div>
            <div class="bdss-card">
                <div class="bdss-title" style="font-size:1.2em; margin-bottom:1.2em;">Tr·∫°ng th√°i</div>
                <span class="bdss-label">Tr·∫°ng th√°i</span>
                @switch (Model.Status)
                {
                    case "Pending":
                        <span class="bdss-badge-soft bdss-badge-soft-warning">Ch·ªù x·ª≠ l√Ω</span>; break;
                    case "Approved":
                        <span class="bdss-badge-soft bdss-badge-soft-success">ƒê√£ duy·ªát</span>; break;
                    case "Completed":
                        <span class="bdss-badge-soft bdss-badge-soft-success">Ho√†n th√†nh</span>; break;
                    case "Rejected":
                        <span class="bdss-badge-soft bdss-badge-soft-danger">T·ª´ ch·ªëi</span>; break;
                    default:
                        <span class="bdss-badge-soft">@Model.Status</span>; break;
                }
                <div class="mt-3">
                    <span class="bdss-label">Ch·ªçn lo·∫°i m√°u ƒë·ªÉ x·ª≠ l√Ω</span>
                    <form method="post" action="@Url.Action("ProcessBloodRequestFromDetails", "Staff")">
                        <input type="hidden" name="bloodRequestId" value="@Model.BloodRequestID" />
                        <select name="selectedBloodTypeId" class="form-select mb-3">
                            @foreach (var type in ViewBag.CompatibleBloodTypes as List<string>)
                            {
                                var bloodType = (ViewBag.AllBloodInventories as List<BloodDonation.Models.BloodInventory>)?.FirstOrDefault(b => b.BloodType.Type == type)?.BloodType;
                                if (bloodType != null)
                                {
                                    <option value="@bloodType.BloodTypeID">@type</option>
                                }
                            }
                        </select>
                        <span class="bdss-label">Ghi ch√∫ x·ª≠ l√Ω</span>
                        <textarea class="form-control" name="note" rows="2" placeholder="Nh·∫≠p ghi ch√∫ x·ª≠ l√Ω..."></textarea>
                        @if (Model.Status == "Completed")
                        {
                            <div class="text-center mt-4 mb-2">
                                <span style="color:#22c55e; font-size:1.25em; font-weight:700;">ƒê√£ ho√†n th√†nh</span>
                            </div>
                        }
                        else
                        {
                            <button type="submit" name="action" value="complete" class="bdss-btn-blue">Ho√†n th√†nh ƒë∆°n</button>
                            <button type="submit" name="action" value="reject" class="bdss-btn-red">T·ª´ ch·ªëi y√™u c·∫ßu</button>
                        }
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<link href="/css/select2.min.css" rel="stylesheet" />
<script src="/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        $('select[name="selectedBloodTypeId"]').select2({
            width: '100%',
            placeholder: 'Ch·ªçn nh√≥m m√°u...',
            allowClear: true
        });
    });
</script> 