@model BloodDonation.Models.DonationAppointment

@{
    Layout = "~/Views/Shared/_LayoutStaff.cshtml";
    ViewData["Title"] = "Chi tiết đăng ký hiến máu";
    var donor = Model.Donor;
}

<style>
    .bdss-card {
        border-radius: 1.2rem;
        box-shadow: 0 2px 16px 0 rgba(0,0,0,0.07);
        border: none;
        background: #fff;
        padding: 2rem 2.5rem 2rem 2.5rem;
        margin-bottom: 1.5rem;
    }
    .bdss-title {
        font-size: 1.5em;
        font-weight: 700;
        color: #22223b;
        margin-bottom: 1.2em;
    }
    .bdss-label {
        color: #64748b;
        font-weight: 500;
        font-size: 1em;
        margin-bottom: 0.2em;
        min-width: 120px;
        display: block;
    }
    .bdss-value {
        font-weight: 600;
        color: #22223b;
        font-size: 1.08em;
        display: block;
        margin-bottom: 0.7em;
    }
    .bdss-badge-soft {
        display: inline-block;
        padding: 0.35em 1.1em;
        font-size: 1.1em;
        font-weight: 500;
        border-radius: 2em;
        background: #fef9c3;
        color: #b45309;
        letter-spacing: 0.02em;
        border: none;
    }
    .bdss-badge-soft-success {
        background: #d1fae5;
        color: #047857;
    }
    .bdss-badge-soft-danger {
        background: #fde8e8;
        color: #b91c1c;
    }
    .bdss-badge-soft-primary {
        background: #dbeafe;
        color: #2563eb;
    }
    .bdss-btn-red {
        background: #ef4444;
        color: #fff;
        border-radius: 0.7em;
        font-weight: 600;
        border: none;
        padding: 0.7em 1.5em;
        margin-bottom: 0.5em;
        transition: background 0.2s;
        width: 100%;
    }
    .bdss-btn-red:hover {
        background: #b91c1c;
        color: #fff;
    }
    .bdss-btn-green {
        background: #22c55e;
        color: #fff;
        border-radius: 0.7em;
        font-weight: 600;
        border: none;
        padding: 0.7em 1.5em;
        margin-bottom: 0.5em;
        transition: background 0.2s;
        width: 100%;
    }
    .bdss-btn-green:hover {
        background: #15803d;
        color: #fff;
    }
    .bdss-status-card {
        border-radius: 1.2rem;
        background: #fff;
        box-shadow: 0 2px 16px 0 rgba(0,0,0,0.07);
        padding: 1.2em 1.5em;
        margin-bottom: 1.5em;
        text-align: center;
    }
    .bdss-alert-info {
        background: #e0f2fe;
        color: #0369a1;
        border-radius: 0.7em;
        padding: 1em 1.2em;
        font-size: 1.05em;
        margin-bottom: 1em;
        text-align: left;
    }
    .bdss-form-label {
        color: #64748b;
        font-weight: 500;
        margin-bottom: 0.3em;
    }
    .bdss-form-control, .bdss-form-select {
        border-radius: 0.7em;
        font-size: 1em;
        margin-bottom: 1em;
    }
</style>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<div class="container mt-4">
    <h2 class="fw-bold mb-3" style="color:#ef4444"><i class="fa-solid fa-droplet"></i> Chi tiết đăng ký hiến máu</h2>
    <div class="row g-4">
        <!-- Card thông tin bên trái -->
        <div class="col-lg-8">
            <div class="bdss-card">
                <div class="bdss-title">Thông tin người hiến máu</div>
                <div class="row">
                    <div class="col-md-6">
                        <span class="bdss-label">Họ và tên</span>
                        <span class="bdss-value">@donor.Name</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">Số điện thoại</span>
                        <span class="bdss-value">@donor.ContactNumber</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">Email</span>
                        <span class="bdss-value">@donor.Account?.Email</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">Ngày sinh</span>
                        <span class="bdss-value">@donor.DateOfBirth?.ToString("yyyy-MM-dd")</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">Giới tính</span>
                        <span class="bdss-value">@donor.Gender</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">Số CMND/CCCD</span>
                        <span class="bdss-value">@donor.CCCD</span>
                    </div>
                    <div class="col-12">
                        <span class="bdss-label">Địa chỉ</span>
                        <span class="bdss-value">@donor.Address</span>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <span class="bdss-label">Nhóm máu</span>
                        <span class="bdss-value">@donor.BloodType?.Type</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">Tiền sử bệnh</span>
                        <span class="bdss-value"><button class="bdss-btn-red" style="padding:0.3em 1.2em; font-size:1em; width:auto;">Xem tiểu sử bệnh án</button></span>
                    </div>
                </div>
            </div>
            <div class="bdss-card">
                <div class="bdss-title" style="font-size:1.2em; margin-bottom:1em;">Thông tin đăng ký</div>
                <div class="row">
                    <div class="col-md-6">
                        <span class="bdss-label">Ngày đăng ký</span>
                        <span class="bdss-value">@Model.AppointmentDate.ToString("yyyy-MM-dd")</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">Ngày hẹn hiến máu</span>
                        <span class="bdss-value">@Model.AppointmentDate.ToString("yyyy-MM-dd")</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">Khung giờ</span>
                        <span class="bdss-value">@Model.TimeSlot</span>
                    </div>
                    <div class="col-md-6">
                        <span class="bdss-label">Nhóm máu hiến</span>
                        <span class="bdss-value">@Model.BloodType?.Type</span>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <span class="bdss-label">Trạng thái</span>
                        @switch (Model.Status)
                        {
                            case "Completed":
                                <span class="bdss-badge-soft bdss-badge-soft-success">Hoàn tất</span>; break;
                            case "Pending":
                                <span class="bdss-badge-soft bdss-badge-soft-warning">Chờ xác nhận</span>; break;
                            case "Rejected":
                                <span class="bdss-badge-soft bdss-badge-soft-danger">Từ chối</span>; break;
                            case "Confirmed":
                                <span class="bdss-badge-soft bdss-badge-soft-primary">Đã xác nhận</span>; break;
                            default:
                                <span class="bdss-badge-soft">@Model.Status</span>; break;
                        }
                    </div>
                </div>
            </div>
            <div class="text-center mb-4">
                <a href="#" class="bdss-btn-red" style="max-width:320px;">Chi tiết phiếu hiến máu</a>
            </div>
        </div>
        <!-- Card xác nhận bên phải -->
        <div class="col-lg-4">
            <div class="bdss-card">
                <div class="bdss-title" style="font-size:1.2em; margin-bottom:1.2em;">Xác nhận hiến máu</div>
                @if (Model.Status == "Completed" || Model.Status == "Rejected")
                {
                    <div class="bdss-alert-info"><b>Thông báo:</b> Đơn hiến máu đã được xử lý với trạng thái <b>@Model.Status</b>. Không thể thay đổi nữa.</div>
                }
                else
                {
                    <form method="post" asp-action="ConfirmDonation" asp-controller="Staff">
                        <input type="hidden" name="AppointmentID" value="@Model.AppointmentID" />
                        <div class="mb-3">
                            <label class="bdss-form-label">Đủ điều kiện hiến máu</label>
                            <div class="d-flex gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="IsEligible" id="eligible" value="true" checked />
                                    <label class="form-check-label text-success fw-bold" for="eligible">✔ Đủ điều kiện</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="IsEligible" id="notEligible" value="false" />
                                    <label class="form-check-label text-danger fw-bold" for="notEligible">✗ Không đủ điều kiện</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="bdss-form-label">Xác nhận nhóm máu</label>
                            <select name="BloodTypeID" class="form-select bdss-form-select">
                                <option value="@Model.BloodTypeID">@Model.BloodType?.Type</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="bdss-form-label">Lượng máu hiến</label>
                            <div class="d-flex gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="QuantityDonated" id="q250" value="0.75" />
                                    <label class="form-check-label" for="q250">250ml (0.75CC)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="QuantityDonated" id="q350" value="1" checked />
                                    <label class="form-check-label" for="q350">350ml (1CC)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="QuantityDonated" id="q450" value="1.25" />
                                    <label class="form-check-label" for="q450">450ml (1.25CC)</label>
                                </div>
                            </div>
                            <div class="form-text">Chọn lượng máu hiến phù hợp</div>
                        </div>
                        <div class="mb-3">
                            <label class="bdss-form-label">Ghi chú</label>
                            <textarea name="Note" class="form-control bdss-form-control" rows="2" placeholder="Nhập ghi chú nếu cần..."></textarea>
                        </div>
                        <button type="submit" name="action" value="reject" class="bdss-btn-red">Từ chối hiến máu</button>
                        <button type="submit" name="action" value="confirm" class="bdss-btn-red">Xác nhận hiến máu</button>
                        <button type="submit" name="action" value="completed" class="bdss-btn-green">Hoàn Thành đơn hiến máu</button>
                    </form>
                }
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
@section Modal {
    @{
        var survey = ViewData["HealthSurvey"] as Dictionary<string, bool>;
        var questionMap = new Dictionary<string, string>
                {
                    ["1_AnhChiDaTungHienMauChua"] = "1. Anh/Chị đã từng hiến máu chưa?",
                    ["2_HienTaiAnhChiCoMacBenhLyKhong"] = "2. Hiện tại Anh/Chị có mắc bệnh lý không?",
                    ["3_TruocDayAnhChiCoMacCacBenhLietKeKhong"] = "3. Trước đây có mắc các bệnh liệt kê không?",
                    ["4_KhoiBenhSauMacCacBenh12Thang"] = "4. Khỏi bệnh sau khi mắc bệnh trong 12 tháng?",
                    ["4_DuocTruyenMauHoacGayGhepMo"] = "5. Được truyền máu hoặc ghép mô?",
                    ["4_TiemVaccine"] = "6. Tiêm vaccine gần đây?",
                    ["5_KhoiBenhSauMacCacBenh6Thang"] = "7. Khỏi bệnh sau mắc bệnh 6 tháng?",
                    ["6_KhoiBenhSauMacCacBenh1Thang"] = "8. Khỏi bệnh sau mắc bệnh 1 tháng?",
                    ["7_BiCumCamLanhHoNhucDauSotDauHong14Ngay"] = "9. Có triệu chứng cảm cúm trong 14 ngày?",
                    ["8_DungThuocKhangSinhKhangVirus"] = "10. Đang dùng kháng sinh/virus?",
                    ["8_DungThuocKhangSinhKhangViemAspirinCorticoide7Ngay"] = "11. Đang dùng Aspirin/Corticoid 7 ngày?",
                    ["9_HienChiDangMangThaiHoacCoThai12ThangTruoc"] = "12. Mang thai hiện tại hoặc 12 tháng trước?",
                    ["9_ChamDutThaiKy12ThangGanDay"] = "13. Chấm dứt thai kỳ 12 tháng gần đây?",
                    ["10_AnhChiSanSangHienMauNeuDuDieuKien"] = "14. Sẵn sàng hiến máu nếu đủ điều kiện?"
                };
    }

    <div class="modal fade" id="healthHistoryModal" tabindex="-1" aria-labelledby="healthHistoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="healthHistoryModalLabel">🩺 Tiểu sử bệnh án</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    @if (survey != null)
                    {
                        <table class="table table-bordered table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Câu hỏi</th>
                                    <th class="text-center">Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in questionMap)
                                {
                                    <tr>
                                        <td>@item.Value</td>
                                        <td class="text-center">
                                            @if (survey.TryGetValue(item.Key, out var value) && value)
                                            {
                                                <span class="text-success fw-bold">✅ Có</span>
                                            }
                                            else
                                            {
                                                <span class="text-danger fw-bold">❌ Không</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p class="text-muted fst-italic">Không có thông tin khảo sát sức khỏe.</p>
                    }
                </div>
            </div>
        </div>
    </div>
}
