@* Copy from NearestDonors.cshtml *@
@{
    ViewData["Title"] = "T√¨m ng∆∞·ªùi hi·∫øn m√°u g·∫ßn nh·∫•t (<= 20km)";
    Layout = "~/Views/Shared/_LayoutStaff.cshtml";
    var bloodBanks = ViewBag.BloodBanks as List<BloodDonation.Models.BloodBank>;
    var selectedBankId = ViewBag.SelectedBankId as int?;
    var donorDistances = ViewBag.DonorDistances;
    var error = ViewBag.Error as string;
}

<div class="container mt-4">
    @if (ViewBag.BloodRequestId != null)
    {
        <a href="@Url.Action("BloodRequestDetails", "Staff", new { id = ViewBag.BloodRequestId })" class="btn btn-outline-secondary mb-3">
            <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i chi ti·∫øt y√™u c·∫ßu nh·∫≠n m√°u
        </a>
    }
    <h3 class="fw-bold mb-3">üîç T√¨m ng∆∞·ªùi hi·∫øn m√°u g·∫ßn nh·∫•t (<= 25km)</h3>
    <hr />
    @if (bloodBanks != null)
    {
        <form method="get" asp-action="NearestDonorsWithin20km" class="mb-4">
            <div class="row g-2 align-items-end">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Ch·ªçn kho m√°u:</label>
                    <select name="bloodBankId" class="form-select" required>
                        <option value="">-- Ch·ªçn kho m√°u --</option>
                        @foreach (var bank in bloodBanks)
                        {
                            <option value="@bank.BloodBankID" selected="@(selectedBankId == bank.BloodBankID ? "selected" : null)">
                                @bank.Name (@bank.Location)
                            </option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Ho·∫∑c nh·∫≠p ƒë·ªãa ch·ªâ kho m√°u:</label>
                    <input type="text" name="customAddress" class="form-control" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ kho m√°u tu·ª≥ √Ω..." value="@ViewBag.CustomAddress" />
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-danger">T√¨m ki·∫øm</button>
                </div>
            </div>
        </form>
    }

    @if (selectedBankId != null && bloodBanks != null)
    {
        var selectedBank = bloodBanks.FirstOrDefault(b => b.BloodBankID == selectedBankId);
        if (selectedBank != null)
        {
            <div class="mb-3">
                <span class="fw-bold">Kho m√°u ƒëang ch·ªçn:</span>
                <span class="text-primary">@selectedBank.Name</span>
                <span class="text-muted">(@selectedBank.Location)</span>
                @if (!string.IsNullOrEmpty(ViewBag.CustomAddress as string))
                {
                    <span class="badge bg-info text-dark ms-2">ƒê·ªãa ch·ªâ tu·ª≥ ch·ªânh: @ViewBag.CustomAddress</span>
                }
            </div>
        }
    }

    @if (!string.IsNullOrEmpty(error))
    {
        <div class="alert alert-danger">@error</div>
    }
    else if (donorDistances != null)
    {
        var donors = donorDistances as IEnumerable<dynamic>;
        var donorsWithin20km = donors?.Where(item => item.Distance <= 25).ToList();
        if (donorsWithin20km != null && donorsWithin20km.Any())
        {
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>T√™n ng∆∞·ªùi hi·∫øn m√°u</th>
                            <th>ƒê·ªãa ch·ªâ</th>
                            <th>S·ªë ƒëi·ªán tho·∫°i</th>
                            <th>Nh√≥m m√°u</th>
                            <th>Kho·∫£ng c√°ch (km)</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            int idx = 1;
                            foreach (var item in donorsWithin20km)
                            {
                                var donor = item.Donor;
                                <tr>
                                    <td>@idx</td>
                                    <td>@donor.Name</td>
                                    <td>@donor.Address</td>
                                    <td>@donor.ContactNumber</td>
                                    <td>@donor.BloodType?.Type</td>
                                    <td>@(item.Distance.ToString("0.00"))</td>
                                    <td>
                                        <form asp-action="SendInviteNotification" asp-controller="Notification" method="post">
                                            <input type="hidden" name="donorId" value="@donor.DonorID" />
                                            <input type="hidden" name="bloodRequestId" value="@ViewBag.BloodRequestId" />
                                            <button type="submit" class="btn btn-warning btn-sm">G·ª≠i th√¥ng b√°o m·ªùi hi·∫øn m√°u</button>
                                        </form>
                                    </td>
                                </tr>
                                idx++;
                            }
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-info">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi hi·∫øn m√°u ph√π h·ª£p trong b√°n k√≠nh 20km.</div>
        }
    }
    else
    {
        <div class="alert alert-info">Vui l√≤ng ch·ªçn kho m√°u ƒë·ªÉ t√¨m ki·∫øm ng∆∞·ªùi hi·∫øn m√°u g·∫ßn nh·∫•t.</div>
    }
</div> 